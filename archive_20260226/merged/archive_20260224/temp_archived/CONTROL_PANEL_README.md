# 🎛️ 设备控制面板 - 完整使用指南

## 📋 目录
1. [快速开始](#快速开始)
2. [功能概览](#功能概览)
3. [启动方式](#启动方式)
4. [详细使用](#详细使用)
5. [故障排查](#故障排查)

---

## 🚀 快速开始

### 第一次使用（3 步）

1. **启动控制面板**
   ```powershell
   C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe start_control_panel.py
   ```

2. **确认连接状态**
   - 顶部状态栏显示"已连接"（绿色）= 正常
   - 显示"未连接"（红色）= 需要检查设备

3. **开始操作**
   - 先用小值测试（位置 1mm，力 10N）
   - 观察实时数据变化
   - 随时可按"🚨 紧急停止"

---

## ⭐ 功能概览

### 1. 实时监控面板
```
┌─────────────────────────────────────────────┐
│  当前位置: 0.00 mm    当前力: 0.00 N       │
│  运行时间: 0.00 s     循环次数: 0          │
└─────────────────────────────────────────────┘
```
- **更新频率**: 100ms (10 次/秒)
- **数据精度**: 小数点后 2 位
- **颜色标识**: 
  - 位置 = 蓝色
  - 力 = 红色

### 2. 运动控制
```
┌─ 位置控制 ─────────────────────────────────┐
│ 目标位置 [mm]: [____]  速度 [mm/s]: [____] │
│                     [移动到位置]            │
└─────────────────────────────────────────────┘
┌─ 力控制 ───────────────────────────────────┐
│ 目标力 [N]: [____]  速度 [N/s]: [____]     │
│                     [加载到目标力]          │
└─────────────────────────────────────────────┘
```

**范围限制**:
- 位置: -100 ~ 100 mm
- 速度: 0.1 ~ 50 mm/s
- 力: -10000 ~ 10000 N
- 加载速度: 0.1 ~ 100 N/s

**快捷按钮**:
- `回零位`: 移动到 0mm
- `回休息位`: 移动到 -34mm (默认)
- `卸载力`: 力设为 0N

### 3. 测量序列
```
┌─ 自动测量 ─────────────────────────────────┐
│ 循环次数: [____]  采样间隔: [____] s       │
│ 样品名称: [________________________]       │
│                                             │
│  [开始测量序列]          [停止序列]        │
└─────────────────────────────────────────────┘
```

**参数说明**:
- **循环次数**: 1 ~ 10000
- **采样间隔**: 0.01 ~ 10 秒
- **样品名称**: 自定义标识（会出现在日志中）

### 4. 紧急控制
```
┌─────────────────────────────────────────────┐
│        🚨 紧急停止 🚨                       │
│    （立即停止所有运动和测量）               │
└─────────────────────────────────────────────┘
```

### 5. 操作日志
```
[14:23:05] 控制面板已启动
[14:23:10] 移动到位置: 5.00 mm, 速度: 2.0 mm/s
[14:23:15] ✓ 开始移动到 5.00 mm
```

---

## 🎯 启动方式

### 方式 1: 独立启动（推荐）
```powershell
# 自动检测设备并连接
C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe start_control_panel.py
```

**优点**: 
- 自动连接设备
- 显示详细启动信息
- 独立窗口，不影响主程序

### 方式 2: 从主程序打开
```powershell
# 1. 先启动主程序
C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe start.py

# 2. 在主窗口点击"打开控制面板"按钮
```

**优点**:
- 共享已连接的驱动
- 可同时使用主程序和控制面板
- 无需重新连接设备

### 方式 3: 模拟测试
```powershell
# 使用模拟驱动测试 UI（无需真实设备）
C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe test_control_panel.py
```

**优点**:
- 无需硬件即可测试
- 模拟实时数据更新
- 验证 UI 功能

---

## 📖 详细使用

### 场景 1: 位置定位测试

**目标**: 将设备移动到指定位置

1. 在"目标位置"输入框输入值，例如 `5.0` (mm)
2. 在"移动速度"输入框设置速度，例如 `2.0` (mm/s)
3. 点击 `[移动到位置]` 按钮
4. 观察:
   - 实时位置值变化（蓝色数字）
   - 日志输出 "✓ 开始移动到 5.00 mm"
5. 等待到达目标位置

**小贴士**:
- 首次测试用 **小位置值** (±1mm)
- 使用 **慢速度** (1-2 mm/s)
- 可随时按"紧急停止"

### 场景 2: 力控制加载

**目标**: 对样品施加指定的力

1. 确保样品已正确装夹
2. 在"目标力"输入框输入值，例如 `10.0` (N)
3. 在"加载速度"设置速度，例如 `0.5` (N/s)
4. 点击 `[加载到目标力]` 按钮
5. 观察:
   - 实时力值变化（红色数字）
   - 日志输出 "✓ 开始加载到 10.00 N"

**安全警告** ⚠️:
- 加载前检查样品状态
- 从小力值开始测试
- 设置合理的速度（建议 < 1 N/s）
- 超出安全范围立即按"紧急停止"

### 场景 3: 自动测量序列

**目标**: 自动采集多组数据

**示例: 5 次循环，每 0.5 秒采样一次**

1. 设置参数:
   - 循环次数: `5`
   - 采样间隔: `0.5`
   - 样品名称: `测试样品-001`

2. 点击 `[开始测量序列]`

3. 系统自动执行:
   ```
   [14:30:00] ========================================
   [14:30:00] 开始测量序列: 测试样品-001
   [14:30:00] 循环次数: 5, 采样间隔: 0.5s
   [14:30:00] ========================================
   [14:30:00] 采样 #1/5
   [14:30:00]   位置: 2.45 mm, 力: 12.30 N
   [14:30:01] 采样 #2/5
   [14:30:01]   位置: 2.47 mm, 力: 12.35 N
   ...
   [14:30:02] 采样 #5/5
   [14:30:02]   位置: 2.50 mm, 力: 12.45 N
   [14:30:02] ========================================
   [14:30:02] ✓ 测量序列完成
   [14:30:02] ========================================
   ```

4. 可随时点击 `[停止序列]` 中断

**应用场景**:
- 材料疲劳测试
- 蠕变监测
- 循环加载测试
- 长时间稳定性观察

### 场景 4: 快速复位

**使用快捷按钮快速操作**

| 按钮 | 功能 | 等效操作 |
|------|------|----------|
| `回零位` | 回到 0mm | 设置位置=0, 点击移动 |
| `回休息位` | 回到默认休息位 | 设置位置=-34mm, 点击移动 |
| `卸载力` | 释放所有力 | 设置力=0N, 点击加载 |

**典型流程**:
```
装夹样品 → 测试 → 卸载力 → 回休息位 → 更换样品
```

---

## 🛠️ 故障排查

### 问题 1: 顶部显示"未连接"

**症状**: 状态栏红色，显示"连接状态: 未连接"

**解决方案**:

1. **检查硬件连接**
   ```powershell
   # 查看 COM 口
   Get-CimInstance Win32_SerialPort | Select-Object Name, DeviceID
   ```
   应该看到类似 `COM5`, `COM6` 等

2. **重新启动控制面板**
   - 关闭当前窗口
   - 检查设备电源
   - 重新运行 `start_control_panel.py`

3. **手动指定端口**（如果自动连接失败）
   编辑 `start_control_panel.py`:
   ```python
   # 在第 40 行附近，改为指定端口
   result = driver.open_link(port=5, baudrate=9600, apiver=0x0289)
   ```

### 问题 2: 实时数据不更新

**症状**: 位置/力值始终显示 0.00

**可能原因 & 解决**:

| 原因 | 解决方法 |
|------|----------|
| 驱动未返回数据 | 检查日志，看是否有错误信息 |
| 数据格式不匹配 | 查看终端输出的数据结构 |
| 定时器未启动 | 重启控制面板 |

**调试步骤**:
```python
# 在终端运行，查看原始数据
python -c "
from drivers.dope_driver import DopeDriver
d = DopeDriver()
d.open_link(port=5, baudrate=9600)
print(d.get_data())
"
```

### 问题 3: 移动命令无响应

**症状**: 点击"移动到位置"后无任何变化

**检查清单**:
- [ ] 设备已连接（状态栏绿色）
- [ ] 输入的位置在范围内 (-100~100)
- [ ] 速度 > 0
- [ ] 查看日志中的错误信息

**日志示例**:
```
[14:25:10] 移动到位置: 5.00 mm, 速度: 2.0 mm/s
[14:25:10] ⚠️ 驱动不支持位置控制
```
→ 说明驱动缺少 `move_to_position` 方法

### 问题 4: 测量序列提前停止

**症状**: 序列只运行了几次就自动停止

**可能原因**:
1. **设备失去连接**
   - 检查 USB 连接
   - 查看日志中的连接错误

2. **数据读取失败**
   - 日志显示 "数据读取失败"
   - 可能是设备忙碌或缓冲区满

3. **意外触发停止**
   - 检查是否误按"停止序列"或"紧急停止"

**解决方法**:
- 增加采样间隔（如 0.1s → 0.5s）
- 检查设备电源稳定性
- 重启设备后重试

### 问题 5: 程序无法启动

**症状**: 双击运行后立即退出

**检查步骤**:

1. **Python 环境**
   ```powershell
   # 检查 32 位环境是否正常
   C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe --version
   ```
   应输出: `Python 3.12.x (32-bit)`

2. **依赖库**
   ```powershell
   # 检查 PyQt5 是否安装
   C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe -c "import PyQt5; print('OK')"
   ```

3. **查看错误**
   ```powershell
   # 在终端运行查看完整错误
   C:\Users\cho77175\Desktop\code\.venv32\Scripts\python.exe start_control_panel.py
   ```

4. **常见错误**:
   - `ImportError: DLL load failed`: 需要 32 位 Python
   - `ModuleNotFoundError: No module named 'PyQt5'`: 需要安装 PyQt5
   - `FileNotFoundError: DoPE.dll`: 检查 DLL 在 `drivers/` 目录

---

## 📊 性能参数

| 指标 | 值 |
|------|-----|
| 数据更新率 | 10 Hz (100ms) |
| 测量采样率 | 用户可配置 (0.01~10s) |
| 位置精度 | 0.01 mm |
| 力精度 | 0.01 N |
| 最大循环次数 | 10000 |
| 日志缓冲 | 自动滚动 |

---

## 🔧 高级配置

### 自定义刷新率

编辑 `control_panel.py` 第 31 行:
```python
self._update_timer.setInterval(100)  # 改为 50 = 20Hz，200 = 5Hz
```

### 自定义范围限制

编辑 `ui/control_panel_ui.py`:
```python
# 位置范围 (第 115-116 行)
self.spin_target_pos.setRange(-100.0, 100.0)  # 改为你的范围

# 力范围 (第 137-138 行)
self.spin_target_force.setRange(-10000.0, 10000.0)
```

### 添加自定义按钮

在 `ui/control_panel_ui.py` 的 `grp_motion` 区域添加:
```python
self.btn_my_custom = QtWidgets.QPushButton(self.grp_motion)
self.btn_my_custom.setText("我的功能")
self.gridLayout_motion.addWidget(self.btn_my_custom, 2, 3)
```

在 `control_panel.py` 的 `__init__` 中连接:
```python
self.ui.btn_my_custom.clicked.connect(self._my_custom_function)

def _my_custom_function(self):
    self._log("执行自定义功能")
    # 你的代码
```

---

## 📞 支持

- **文档位置**: `C:\Users\cho77175\Desktop\code\CONTROL_PANEL_GUIDE.md`
- **UI 源码**: `ui/control_panel_ui.py`
- **业务逻辑**: `control_panel.py`
- **驱动接口**: `drivers/dope_driver*.py`

---

## ✅ 快速验证清单

使用前检查:
- [ ] 设备已接电源
- [ ] USB 连接正常
- [ ] COM 口在设备管理器中正常显示
- [ ] 32 位 Python 环境已激活
- [ ] 控制面板状态栏显示"已连接"

首次操作:
- [ ] 小位置值测试 (±1mm)
- [ ] 慢速度测试 (1-2 mm/s)
- [ ] 观察实时数据变化
- [ ] 测试紧急停止按钮
- [ ] 记录操作日志

---

**祝使用愉快！** 🎉

有问题查看日志，实在解决不了就紧急停止后重启！
